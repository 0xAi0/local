<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SecureSync 256</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: '#050505',
              surface: '#0a0a0a',
              panel: '#111111',
              primary: '#00ff9d',
              'primary-dim': 'rgba(0, 255, 157, 0.1)',
              secondary: '#94a3b8',
              danger: '#ef4444',
            },
            fontFamily: {
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>
    <style>
      body { background-color: #050505; color: #e2e8f0; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0a0a0a; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #00ff9d; }
      .scan-line {
        position: fixed; top: 0; left: 0; width: 100%; height: 2px;
        background: rgba(0, 255, 157, 0.3);
        animation: scan 4s linear infinite; pointer-events: none; z-index: 50;
      }
      @keyframes scan {
        0% { transform: translateY(-100vh); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(100vh); opacity: 0; }
      }
      .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="scan-line"></div>
    
    <div id="app-container" class="min-h-screen flex flex-col font-sans bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-900 to-black">
        
        <!-- HEADER -->
        <header id="header" class="hidden p-4 border-b border-gray-800 bg-panel flex justify-between items-center shadow-lg z-10">
             <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-3 h-3 bg-primary rounded-full animate-pulse"></div>
                    <div class="absolute inset-0 bg-primary rounded-full animate-ping opacity-20"></div>
                </div>
                <div>
                  <h1 class="font-bold text-lg tracking-wider">SECURE<span class="text-primary">SYNC</span></h1>
                  <div class="flex items-center gap-1 text-[10px] text-gray-500 font-mono">
                    <i data-lucide="lock" class="w-3 h-3 text-primary"></i>
                    AES-256-GCM
                  </div>
                </div>
            </div>
            <button onclick="window.location.href = window.location.pathname" class="text-xs text-red-500 hover:text-red-400 border border-red-900/50 px-3 py-1.5 rounded hover:bg-red-900/20 transition">
                EXIT
            </button>
        </header>

        <!-- VIEWS -->
        <main id="main-content" class="flex-1 flex flex-col items-center justify-center p-4">
            
            <!-- VIEW: INIT -->
            <div id="view-init" class="view max-w-md w-full bg-panel border border-gray-800 rounded-xl shadow-2xl overflow-hidden relative p-8 hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary to-transparent opacity-50"></div>
                <div class="flex justify-center mb-6">
                    <i data-lucide="shield" class="w-16 h-16 text-primary animate-pulse-slow"></i>
                </div>
                <h1 class="text-2xl font-bold text-center mb-2 text-white tracking-tight">SECURE<span class="text-primary">SYNC</span></h1>
                <p class="text-center text-gray-500 mb-8 text-sm">One-click encrypted sharing.</p>
                
                <div class="space-y-4">
                    <button onclick="App.createRoom()" class="w-full bg-primary/10 hover:bg-primary/20 border border-primary/50 text-primary p-4 rounded-lg flex items-center justify-center gap-3 transition-all group">
                        <i data-lucide="plus-circle" class="group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold">CREATE SECURE ROOM</span>
                    </button>
                    
                    <div class="relative mt-6 pt-4 border-t border-gray-800 text-center">
                        <p class="text-xs text-gray-600 mb-2">How it works</p>
                        <div class="flex justify-center gap-4 text-xs text-gray-500">
                             <span class="flex items-center gap-1"><i data-lucide="link" class="w-3 h-3"></i> Share Link</span>
                             <span class="flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> Auto-Connect</span>
                             <span class="flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> E2E Encrypted</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: LOADING -->
            <div id="view-loading" class="view hidden">
                <div class="p-12 flex flex-col items-center text-center">
                    <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                    <h2 class="text-white font-bold mb-2" id="loading-text">Establishing Connection</h2>
                    <p class="text-gray-500 text-sm font-mono text-xs" id="loading-sub">HANDSHAKE_INIT</p>
                </div>
            </div>

            <!-- VIEW: HOST WAITING -->
            <div id="view-host-waiting" class="view max-w-md w-full bg-panel border border-gray-800 rounded-xl shadow-2xl overflow-hidden relative p-6 hidden">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="wifi" class="w-5 h-5 text-primary"></i> Room Active
                </h2>
                <div class="bg-black p-4 rounded-lg mb-6 border border-gray-800 flex flex-col items-center">
                    <div id="host-qr" class="bg-white p-2 rounded mb-4"></div>
                    <p class="text-xs text-gray-500 mb-2">Scan or Share Link to Join</p>
                    <div class="w-full flex gap-2">
                        <input id="host-link-input" readOnly class="flex-1 bg-gray-900 border border-gray-700 text-xs text-gray-400 p-2 rounded truncate font-mono" />
                        <button onclick="App.copyHostLink()" class="p-2 bg-gray-800 hover:bg-gray-700 rounded text-white transition-colors">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-center">
                    <div class="flex items-center gap-2 px-4 py-2 bg-gray-900 rounded-full border border-gray-800">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-gray-400">Waiting for peer...</span>
                    </div>
                </div>
            </div>

            <!-- VIEW: CHAT -->
            <div id="view-chat" class="view w-full max-w-2xl h-[80vh] flex-col hidden">
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 border border-gray-800 bg-panel/50 rounded-t-xl">
                    <div class="flex justify-center my-4">
                        <span class="bg-gray-900 text-gray-500 text-xs px-3 py-1 rounded-full border border-gray-800 font-mono flex items-center gap-2">
                          <i data-lucide="shield-check" class="w-3 h-3 text-primary"></i> End-to-End Encrypted
                        </span>
                    </div>
                </div>
                <form onsubmit="App.sendMessage(event)" class="p-4 bg-panel border border-t-0 border-gray-800 rounded-b-xl flex gap-2">
                    <input id="chat-input" autocomplete="off" type="text" placeholder="Type a message..." class="flex-1 bg-background border border-gray-700 text-white px-4 py-3 rounded focus:outline-none focus:border-primary font-mono text-sm transition-colors" />
                    <button type="submit" class="bg-primary text-black font-bold px-6 rounded hover:bg-green-400 transition-colors">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>

        </main>
        
        <footer class="p-4 text-center">
            <div class="text-[10px] text-gray-600 font-mono">SECURE_SYNC_256 // PEERJS_SIGNALING // AES_GCM</div>
        </footer>
    </div>

    <script>
        /**
         * CRYPTOGRAPHY MODULE
         */
        const Security = {
            async generateKey() {
                return window.crypto.subtle.generateKey(
                    { name: "AES-GCM", length: 256 },
                    true, ["encrypt", "decrypt"]
                );
            },
            async exportKey(key) {
                const exported = await window.crypto.subtle.exportKey("raw", key);
                return this.buffToBase64(exported);
            },
            async importKey(base64Key) {
                const rawKey = this.base64ToBuff(base64Key);
                return window.crypto.subtle.importKey(
                    "raw", rawKey, "AES-GCM", true, ["encrypt", "decrypt"]
                );
            },
            async encryptData(text, key) {
                const encoder = new TextEncoder();
                const encoded = encoder.encode(text);
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv }, key, encoded
                );
                return {
                    iv: this.buffToBase64(iv.buffer),
                    data: this.buffToBase64(encrypted)
                };
            },
            async decryptData(encryptedData, ivStr, key) {
                const iv = this.base64ToBuff(ivStr);
                const data = this.base64ToBuff(encryptedData);
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(iv) }, key, data
                );
                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            },
            buffToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            },
            base64ToBuff(base64) {
                const binary_string = window.atob(base64);
                const len = binary_string.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binary_string.charCodeAt(i);
                }
                return bytes.buffer;
            }
        };

        /**
         * APP LOGIC
         */
        const App = {
            peer: null,
            conn: null,
            key: null,
            link: '',
            
            init() {
                lucide.createIcons();
                
                // Parse URL Hash: #<RoomID>.<Key>
                const hash = window.location.hash.substring(1);
                
                if (hash && hash.includes('.')) {
                    this.joinRoom(hash);
                } else {
                    this.switchView('view-init');
                }
            },

            switchView(viewId) {
                document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                
                if (viewId === 'view-chat') {
                    document.getElementById('header').classList.remove('hidden');
                    document.getElementById('app-container').classList.remove('items-center', 'justify-center');
                } else {
                    document.getElementById('header').classList.add('hidden');
                    document.getElementById('app-container').classList.add('items-center', 'justify-center');
                }
                lucide.createIcons();
            },

            setLoading(text, subtext = "") {
                document.getElementById('loading-text').innerText = text;
                document.getElementById('loading-sub').innerText = subtext;
                this.switchView('view-loading');
            },

            // --- HOST LOGIC ---

            async createRoom() {
                this.setLoading("Creating Secure Room", "GENERATING_KEYS");
                
                try {
                    // 1. Generate Encryption Key
                    const key = await Security.generateKey();
                    this.key = key;
                    const rawKey = await Security.exportKey(key);

                    // 2. Init PeerJS with random UUID
                    // Note: We use a random UUID for the PeerID so it's unique
                    const peerId = 'SS256-' + crypto.randomUUID().split('-')[0];
                    
                    this.peer = new Peer(peerId);

                    this.peer.on('open', (id) => {
                        console.log('My peer ID is: ' + id);
                        
                        // 3. Construct Link
                        const baseUrl = window.location.href.split('#')[0];
                        const link = `${baseUrl}#${id}.${rawKey}`;
                        this.link = link;

                        // 4. Show UI
                        document.getElementById('host-link-input').value = link;
                        document.getElementById('host-qr').innerHTML = '';
                        new QRCode(document.getElementById('host-qr'), {
                            text: link,
                            width: 180, height: 180,
                            colorDark : "#00ff9d", colorLight : "#0a0a0a",
                            correctLevel : QRCode.CorrectLevel.L
                        });
                        
                        this.switchView('view-host-waiting');
                    });

                    this.peer.on('connection', (conn) => {
                        this.setupConnection(conn);
                    });
                    
                    this.peer.on('error', (err) => {
                        console.error(err);
                        alert("Connection Error: " + err.type);
                        this.switchView('view-init');
                    });

                } catch (e) {
                    console.error(e);
                    alert("Initialization Failed");
                    this.switchView('view-init');
                }
            },

            // --- GUEST LOGIC ---

            async joinRoom(hash) {
                this.setLoading("Connecting to Room", "RESOLVING_PEER");
                
                try {
                    const [peerId, keyString] = hash.split('.');
                    if (!peerId || !keyString) throw new Error("Invalid Link");

                    // 1. Import Key
                    this.key = await Security.importKey(keyString);

                    // 2. Init Peer (Guest doesn't need a specific ID)
                    this.peer = new Peer();

                    this.peer.on('open', () => {
                        // 3. Connect to Host
                        this.setLoading("Secure Handshake", "VERIFYING_ENCRYPTION");
                        const conn = this.peer.connect(peerId);
                        
                        conn.on('open', () => {
                            this.setupConnection(conn);
                            
                            // Send Hello to confirm encryption works
                            this.sendRaw(conn, "HELLO_PEER");
                        });

                        conn.on('error', (err) => {
                             alert("Could not connect to peer. Room might be closed.");
                             this.switchView('view-init');
                        });
                    });

                    this.peer.on('error', (err) => {
                        console.error(err);
                        alert("Network Error. Please try again.");
                        this.switchView('view-init');
                    });

                } catch (e) {
                    console.error(e);
                    alert("Invalid Link");
                    this.switchView('view-init');
                }
            },

            // --- SHARED LOGIC ---

            setupConnection(conn) {
                this.conn = conn;

                this.conn.on('data', async (data) => {
                    try {
                        const payload = JSON.parse(data);
                        if (payload.iv && payload.data && this.key) {
                            const text = await Security.decryptData(payload.data, payload.iv, this.key);
                            
                            // Handshake check (optional, but good for UX)
                            if (text === "HELLO_PEER") {
                                console.log("Peer Verified");
                                return;
                            }
                            
                            this.appendMessage(text, 'peer');
                        }
                    } catch (e) {
                        console.error("Decryption failed", e);
                    }
                });

                this.conn.on('close', () => {
                    alert("Connection closed by peer");
                    window.location.reload();
                });

                // Clean URL for Guest
                if (window.location.hash) {
                    history.replaceState(null, '', window.location.pathname);
                }
                
                this.switchView('view-chat');
            },

            async sendMessage(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                
                if (!text) return;
                
                this.sendRaw(this.conn, text);
                this.appendMessage(text, 'me');
                input.value = '';
            },

            async sendRaw(conn, text) {
                if (!conn || !this.key) return;
                try {
                    const encrypted = await Security.encryptData(text, this.key);
                    conn.send(JSON.stringify(encrypted));
                } catch (e) {
                    console.error("Send error", e);
                }
            },

            appendMessage(text, sender) {
                const container = document.getElementById('chat-messages');
                const div = document.createElement('div');
                div.className = `flex ${sender === 'me' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `max-w-[85%] sm:max-w-[70%] p-3 rounded-lg border shadow-sm ${
                    sender === 'me' 
                    ? 'bg-primary-dim border-primary/30 text-primary-50' 
                    : 'bg-panel border-gray-800 text-gray-200'
                }`;
                
                const pText = document.createElement('p');
                pText.className = "text-sm whitespace-pre-wrap break-words";
                pText.textContent = text;
                
                const pTime = document.createElement('p');
                pTime.className = "text-[10px] opacity-50 mt-1 text-right font-mono";
                pTime.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                bubble.appendChild(pText);
                bubble.appendChild(pTime);
                div.appendChild(bubble);
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },

            copyHostLink() {
                navigator.clipboard.writeText(this.link);
                const btn = document.querySelector('#host-link-input + button');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-primary"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    lucide.createIcons();
                }, 1500);
            }
        };

        // Initialize
        App.init();
    </script>
</body>
</html>