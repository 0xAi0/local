<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SecureSync 256</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: '#050505',
              surface: '#0a0a0a',
              panel: '#111111',
              primary: '#00ff9d',
              'primary-dim': 'rgba(0, 255, 157, 0.1)',
              secondary: '#94a3b8',
              danger: '#ef4444',
            },
            fontFamily: {
              mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>
    <style>
      body { background-color: #050505; color: #e2e8f0; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0a0a0a; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #00ff9d; }
      .scan-line {
        position: fixed; top: 0; left: 0; width: 100%; height: 2px;
        background: rgba(0, 255, 157, 0.3);
        animation: scan 4s linear infinite; pointer-events: none; z-index: 50;
      }
      @keyframes scan {
        0% { transform: translateY(-100vh); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(100vh); opacity: 0; }
      }
      .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="scan-line"></div>
    
    <div id="app-container" class="min-h-screen flex flex-col font-sans bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-900 to-black">
        
        <!-- HEADER -->
        <header id="header" class="hidden p-4 border-b border-gray-800 bg-panel flex justify-between items-center shadow-lg z-10">
             <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-3 h-3 bg-primary rounded-full animate-pulse"></div>
                    <div class="absolute inset-0 bg-primary rounded-full animate-ping opacity-20"></div>
                </div>
                <div>
                  <h1 class="font-bold text-lg tracking-wider">SECURE<span class="text-primary">SYNC</span></h1>
                  <div class="flex items-center gap-1 text-[10px] text-gray-500 font-mono">
                    <i data-lucide="lock" class="w-3 h-3 text-primary"></i>
                    AES-256-GCM ENCRYPTED
                  </div>
                </div>
            </div>
            <button onclick="window.location.reload()" class="text-xs text-red-500 hover:text-red-400 border border-red-900/50 px-3 py-1.5 rounded hover:bg-red-900/20 transition">
                TERMINATE
            </button>
        </header>

        <!-- VIEWS -->
        <main id="main-content" class="flex-1 flex flex-col items-center justify-center p-4">
            
            <!-- VIEW: INIT -->
            <div id="view-init" class="view max-w-md w-full bg-panel border border-gray-800 rounded-xl shadow-2xl overflow-hidden relative p-8 hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary to-transparent opacity-50"></div>
                <div class="flex justify-center mb-6">
                    <i data-lucide="shield" class="w-16 h-16 text-primary animate-pulse-slow"></i>
                </div>
                <h1 class="text-2xl font-bold text-center mb-2 text-white tracking-tight">SECURE<span class="text-primary">SYNC</span></h1>
                <p class="text-center text-gray-500 mb-8 text-sm">Military-grade offline communication.</p>
                
                <div class="space-y-4">
                    <button onclick="App.startHost()" class="w-full bg-primary/10 hover:bg-primary/20 border border-primary/50 text-primary p-4 rounded-lg flex items-center justify-center gap-3 transition-all group">
                        <i data-lucide="monitor" class="group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold">CREATE ROOM</span>
                    </button>
                    <div class="text-center text-xs text-gray-600 font-mono my-2">- OR -</div>
                    <div class="relative">
                        <input disabled placeholder="Waiting for Invite Link..." class="w-full bg-black/50 border border-gray-800 p-3 rounded text-center text-gray-500 text-sm cursor-not-allowed"/>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="bg-panel px-2 text-xs text-gray-400">Open a shared link to join</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: HOST WAITING -->
            <div id="view-host-waiting" class="view max-w-md w-full bg-panel border border-gray-800 rounded-xl shadow-2xl overflow-hidden relative p-6 hidden">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="monitor" class="w-5 h-5 text-primary"></i> Room Ready
                </h2>
                <div class="bg-black p-4 rounded-lg mb-6 border border-gray-800 flex flex-col items-center">
                    <div id="host-qr" class="bg-white p-2 rounded mb-4"></div>
                    <p class="text-xs text-gray-500 mb-2">Scan to join securely</p>
                    <div class="w-full flex gap-2">
                        <input id="host-link-input" readOnly class="flex-1 bg-gray-900 border border-gray-700 text-xs text-gray-400 p-2 rounded truncate font-mono" />
                        <button onclick="App.copyHostLink()" class="p-2 bg-gray-800 hover:bg-gray-700 rounded text-white">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div class="border-t border-gray-800 pt-6">
                    <h3 class="text-sm font-medium text-gray-300 mb-3">Complete Connection</h3>
                    <p class="text-xs text-gray-500 mb-3">If Guest cannot scan, paste their <span class="text-primary">Response Code</span> below:</p>
                    <textarea id="host-manual-input" placeholder="Paste Guest Response Code here..." class="w-full bg-black/50 border border-gray-700 rounded p-3 text-xs text-white font-mono h-20 mb-3 focus:border-primary focus:outline-none resize-none"></textarea>
                    <button onclick="App.handleHostProcessAnswer()" class="w-full bg-secondary/20 hover:bg-secondary/30 text-white py-2 rounded font-medium text-sm transition-colors">
                        VERIFY & CONNECT
                    </button>
                </div>
            </div>

            <!-- VIEW: GUEST PROCESSING -->
            <div id="view-guest-processing" class="view hidden">
                <div class="p-12 flex flex-col items-center text-center">
                    <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                    <h2 class="text-white font-bold mb-2">Establishing Secure Uplink</h2>
                    <p class="text-gray-500 text-sm">Verifying encryption keys...</p>
                </div>
            </div>

            <!-- VIEW: GUEST ANSWER -->
            <div id="view-guest-answer" class="view max-w-md w-full bg-panel border border-gray-800 rounded-xl shadow-2xl overflow-hidden relative p-6 hidden">
                <div class="flex items-center gap-2 mb-4 text-green-400">
                    <i data-lucide="check" class="w-5 h-5"></i>
                    <h2 class="font-bold">Keys Exchanged</h2>
                 </div>
                 <p class="text-sm text-gray-400 mb-6">
                   To finish, copy this code and send it back to the Host (or paste it on their device).
                 </p>
     
                 <div class="bg-black p-4 rounded border border-gray-800 mb-6 relative group">
                    <code id="guest-answer-code" class="text-xs text-primary font-mono break-all line-clamp-4 block"></code>
                    <button onclick="App.copyGuestAnswer()" class="absolute top-2 right-2 bg-gray-800 p-1.5 rounded text-white hover:bg-gray-700">
                      <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                 </div>
     
                 <div class="bg-yellow-900/20 border border-yellow-900/50 p-3 rounded flex gap-3">
                   <i data-lucide="alert-circle" class="w-4 h-4 text-yellow-500 shrink-0 mt-0.5"></i>
                   <p class="text-xs text-yellow-200/70">
                     Waiting for Host to confirm connection...
                   </p>
                 </div>
            </div>

            <!-- VIEW: CHAT -->
            <div id="view-chat" class="view w-full max-w-2xl h-[80vh] flex-col hidden">
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 border border-gray-800 bg-panel/50 rounded-t-xl">
                    <div class="flex justify-center my-4">
                        <span class="bg-gray-900 text-gray-500 text-xs px-3 py-1 rounded-full border border-gray-800 font-mono">
                          Session Secured
                        </span>
                    </div>
                </div>
                <form onsubmit="App.sendMessage(event)" class="p-4 bg-panel border border-t-0 border-gray-800 rounded-b-xl flex gap-2">
                    <input id="chat-input" type="text" placeholder="Enter encrypted message..." class="flex-1 bg-background border border-gray-700 text-white px-4 py-3 rounded focus:outline-none focus:border-primary font-mono text-sm" />
                    <button type="submit" class="bg-primary text-black font-bold px-6 rounded hover:bg-green-400 transition-colors">SEND</button>
                </form>
            </div>

        </main>
        
        <footer class="p-4 text-center">
            <div class="text-[10px] text-gray-600 font-mono">SECURE_SYNC_V2.0 // AES-256-GCM // NO_LOGS</div>
        </footer>
    </div>

    <script>
        /**
         * UTILS & SECURITY
         */
        const Security = {
            async generateKey() {
                return window.crypto.subtle.generateKey(
                    { name: "AES-GCM", length: 256 },
                    true, ["encrypt", "decrypt"]
                );
            },
            async exportKey(key) {
                const exported = await window.crypto.subtle.exportKey("raw", key);
                return this.buffToBase64(exported);
            },
            async importKey(base64Key) {
                const rawKey = this.base64ToBuff(base64Key);
                return window.crypto.subtle.importKey(
                    "raw", rawKey, "AES-GCM", true, ["encrypt", "decrypt"]
                );
            },
            async encryptData(text, key) {
                const encoder = new TextEncoder();
                const encoded = encoder.encode(text);
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv }, key, encoded
                );
                return {
                    iv: this.buffToBase64(iv.buffer),
                    data: this.buffToBase64(encrypted)
                };
            },
            async decryptData(encryptedData, ivStr, key) {
                const iv = this.base64ToBuff(ivStr);
                const data = this.base64ToBuff(encryptedData);
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(iv) }, key, data
                );
                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            },
            buffToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            },
            base64ToBuff(base64) {
                const binary_string = window.atob(base64);
                const len = binary_string.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binary_string.charCodeAt(i);
                }
                return bytes.buffer;
            }
        };

        const LinkUtil = {
            generateHash(sdp, key) {
                const payload = JSON.stringify({ s: sdp, k: key });
                return LZString.compressToEncodedURIComponent(payload);
            },
            parseHash(hash) {
                try {
                    const decompressed = LZString.decompressFromEncodedURIComponent(hash);
                    if (!decompressed) return null;
                    return JSON.parse(decompressed);
                } catch (e) {
                    console.error("Link parse error", e);
                    return null;
                }
            }
        };

        /**
         * APP LOGIC
         */
        const App = {
            state: {
                pc: null,
                dc: null,
                key: null,
                link: ''
            },
            
            init() {
                lucide.createIcons();
                
                // Check Hash for Guest Mode
                const hash = window.location.hash.substring(1);
                if (hash) {
                    this.handleGuestLoad(hash);
                } else {
                    this.switchView('view-init');
                }
            },

            switchView(viewId) {
                document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                
                if (viewId === 'view-chat') {
                    document.getElementById('header').classList.remove('hidden');
                    document.getElementById('app-container').classList.remove('items-center', 'justify-center');
                } else {
                    document.getElementById('header').classList.add('hidden');
                    document.getElementById('app-container').classList.add('items-center', 'justify-center');
                }
                lucide.createIcons();
            },

            createPeer() {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                pc.oniceconnectionstatechange = () => {
                    if (pc.iceConnectionState === 'disconnected') {
                        alert('Peer disconnected');
                        location.reload();
                    }
                };
                return pc;
            },

            setupDataChannel(dc) {
                this.state.dc = dc;
                dc.onopen = () => {
                    this.switchView('view-chat');
                };
                dc.onmessage = async (e) => {
                    try {
                        const payload = JSON.parse(e.data);
                        if (payload.iv && payload.data && this.state.key) {
                            const text = await Security.decryptData(payload.data, payload.iv, this.state.key);
                            this.appendMessage(text, 'peer');
                        }
                    } catch (err) {
                        console.error("Decrypt failed", err);
                    }
                };
            },

            async startHost() {
                this.switchView('view-guest-processing'); // Show loader momentarily
                try {
                    // Generate Key
                    const key = await Security.generateKey();
                    this.state.key = key;
                    const rawKey = await Security.exportKey(key);

                    // WebRTC
                    const pc = this.createPeer();
                    this.state.pc = pc;
                    const dc = pc.createDataChannel("secure-chat");
                    this.setupDataChannel(dc);

                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);

                    await this.waitForIce(pc);

                    // Create Link
                    const hash = LinkUtil.generateHash(pc.localDescription, rawKey);
                    // Handle GitHub Pages URL structure correctly
                    const baseUrl = window.location.href.split('#')[0];
                    const link = `${baseUrl}#${hash}`;
                    this.state.link = link;

                    this.switchView('view-host-waiting');
                    
                    // Render UI
                    document.getElementById('host-link-input').value = link;
                    document.getElementById('host-qr').innerHTML = '';
                    new QRCode(document.getElementById('host-qr'), {
                        text: link,
                        width: 180, height: 180,
                        colorDark : "#00ff9d", colorLight : "#0a0a0a",
                        correctLevel : QRCode.CorrectLevel.L
                    });

                } catch (e) {
                    console.error(e);
                    alert("Host initialization failed");
                    location.reload();
                }
            },

            async handleGuestLoad(hash) {
                this.switchView('view-guest-processing');
                try {
                    const data = LinkUtil.parseHash(hash);
                    if (!data) throw new Error("Invalid Link");

                    const key = await Security.importKey(data.k);
                    this.state.key = key;

                    const pc = this.createPeer();
                    this.state.pc = pc;
                    pc.ondatachannel = (e) => this.setupDataChannel(e.channel);

                    await pc.setRemoteDescription(new RTCSessionDescription(data.s));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    await this.waitForIce(pc);

                    const answerString = btoa(JSON.stringify(pc.localDescription));
                    document.getElementById('guest-answer-code').innerText = answerString;
                    
                    this.switchView('view-guest-answer');
                    // Clean URL
                    history.replaceState(null, '', window.location.pathname);

                } catch (e) {
                    console.error(e);
                    alert("Invalid or Expired Link");
                    this.switchView('view-init');
                }
            },

            async handleHostProcessAnswer() {
                const input = document.getElementById('host-manual-input').value.trim();
                if (!input) return;
                
                try {
                    let answerSDP = null;
                    try { answerSDP = JSON.parse(atob(input)); } catch(e) {}
                    if (!answerSDP && input.startsWith('{')) {
                        try { answerSDP = JSON.parse(input); } catch(e) {}
                    }

                    if (answerSDP && this.state.pc) {
                        await this.state.pc.setRemoteDescription(new RTCSessionDescription(answerSDP));
                    } else {
                        alert("Invalid Code");
                    }
                } catch(e) {
                    console.error(e);
                    alert("Connection failed");
                }
            },

            waitForIce(pc) {
                return new Promise(resolve => {
                    if (pc.iceGatheringState === 'complete') resolve();
                    else {
                        const check = () => {
                            if (pc.iceGatheringState === 'complete') {
                                pc.removeEventListener('icegatheringstatechange', check);
                                resolve();
                            }
                        };
                        pc.addEventListener('icegatheringstatechange', check);
                    }
                });
            },

            async sendMessage(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text || !this.state.key || !this.state.dc) return;

                try {
                    const encrypted = await Security.encryptData(text, this.state.key);
                    this.state.dc.send(JSON.stringify(encrypted));
                    this.appendMessage(text, 'me');
                    input.value = '';
                } catch (e) {
                    console.error("Send failed", e);
                }
            },

            appendMessage(text, sender) {
                const container = document.getElementById('chat-messages');
                const div = document.createElement('div');
                div.className = `flex ${sender === 'me' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `max-w-[85%] sm:max-w-[70%] p-3 rounded-lg border ${
                    sender === 'me' 
                    ? 'bg-primary-dim border-primary/30 text-primary-50' 
                    : 'bg-panel border-gray-800 text-gray-200'
                }`;
                
                const pText = document.createElement('p');
                pText.className = "text-sm";
                pText.textContent = text;
                
                const pTime = document.createElement('p');
                pTime.className = "text-[10px] opacity-50 mt-1 text-right font-mono";
                pTime.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                bubble.appendChild(pText);
                bubble.appendChild(pTime);
                div.appendChild(bubble);
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },

            copyHostLink() {
                navigator.clipboard.writeText(this.state.link);
                alert("Link copied!");
            },

            copyGuestAnswer() {
                const text = document.getElementById('guest-answer-code').innerText;
                navigator.clipboard.writeText(text);
                alert("Code copied!");
            }
        };

        // Initialize
        App.init();
    </script>
</body>
</html>